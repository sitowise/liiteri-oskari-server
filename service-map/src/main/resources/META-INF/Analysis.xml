<?xml version="1.0" encoding="UTF-8" ?>

<!DOCTYPE sqlMap      
    PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN"      
    "http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="Analysis">

    <!-- Use type aliases to avoid typing the full classname every time. -->
    <typeAlias alias="Analysis"
        type="fi.nls.oskari.domain.map.analysis.Analysis" />

	<typeAlias alias="UserGisData" type="fi.nls.oskari.domain.map.UserGisData" />

    <resultMap id="AnalysisResult" class="Analysis">
        <result property="id" column="id" />
        <result property="uuid" column="uuid" />
        <result property="name" column="name" />
        <result property="layer_id" column="layer_id" />
        <result property="analyse_json" column="analyse_json" />
        <result property="style_id" column="style_id" />
        <result property="col1" column="col1" />
        <result property="col2" column="col2" />
        <result property="col3" column="col3" />
        <result property="col4" column="col4" />
        <result property="col5" column="col5" />
        <result property="col6" column="col6" />
        <result property="col7" column="col7" />
        <result property="col8" column="col8" />
        <result property="col9" column="col9" />
        <result property="col10" column="col10" />
        <result property="select_to_data" column="select_to_data" />
        <result property="override_sld" column="override_sld" />

    </resultMap>
    
    <resultMap id="UserGisDataResult" class="UserGisData">
		<result property="dataId" column="data_id" />
		<result property="downloadServiceUrl" column="download_service_url" />
		<result property="expirationDate" column="expirationdate" />
	</resultMap>



    <select id="findAnalysis" parameterClass="long" resultMap="AnalysisResult">
        select
        id,
        uuid,
        name,
        layer_id,
        analyse_json,
        style_id,
        col1,
        col2,
        col3,
        col4,
        col5,
        col6,
        col7,
        col8,
        col9,
        col10,
        select_to_data,
        override_sld

        from
        analysis
        where id = #id# 
 
    </select>

    <select id="findByIds" parameterClass="List" resultMap="AnalysisResult">
        select
        id,
        uuid,
        name,
        layer_id,
        analyse_json,
        style_id,
        col1,
        col2,
        col3,
        col4,
        col5,
        col6,
        col7,
        col8,
        col9,
        col10,
        select_to_data,
        override_sld

        from
        analysis
        where id in
        <iterate open="(" close=")" conjunction=",">
            #[]#
        </iterate>
    </select>
    
     <select id="findAnalysisByUid" parameterClass="string" resultMap="AnalysisResult">
        select
        id,
        uuid,
        name,
        layer_id,
        analyse_json,
        style_id,
        col1,
        col2,
        col3,
        col4,
        col5,
        col6,
        col7,
        col8,
        col9,
        col10,
        select_to_data,
        override_sld

        from
        analysis
        where uuid = #uid# 
 
    </select>

    <select id="findAnalysisDataByIdUid" parameterClass="java.util.HashMap" resultClass="java.util.HashMap" remapResults = "true" >
        select
        <dynamic>
            $select_items$
        </dynamic>

        from
        analysis_data
        where analysis_id = #id# and uuid=#uuid#

    </select>

    <statement id="deleteAnalysis" parameterClass="long">
        delete from
        analysis where id=#analysisId#
    </statement>



    <statement id="insertAnalysis" resultClass="java.lang.Long"
        parameterClass="Analysis">
        INSERT INTO analysis (
        uuid,
        name,
        layer_id,
        analyse_json,
        style_id,
        col1,
        col2,
        col3,
        col4,
        col5,
        col6,
        col7,
        col8,
        col9,
        col10,
        select_to_data,
        override_sld)
        VALUES ( #uuid#,
        #name#,
        #layer_id#,
        #analyse_json#,
        #style_id#,
        #col1#,
        #col2#,
        #col3#,
        #col4#,
        #col5#,
        #col6#,
        #col7#,
        #col8#,
        #col9#,
        #col10#,
        #select_to_data#,
        #override_sld#)
        RETURNING
        id
    </statement>


    <update id="updateAnalysisCols" parameterClass="Analysis">
        update
        analysis set
        col1 = #col1#,
        col2 = #col2#,
        col3 = #col3#,
        col4 = #col4#,
        col5 = #col5#,
        col6 = #col6#,
        col7 = #col7#,
        col8 = #col8#,
        col9 = #col9#,
        col10 = #col10#,
        select_to_data = #select_to_data#

        where id = #id#
    </update>
    <update id="merge-analysis-data" parameterClass="Analysis">
    update
    analysis_data set
    analysis_id = #id#
    WHERE analysis_id = #old_id#
    </update>

    <statement id="delete-analysis-data"
               parameterClass="java.lang.Long">
        DELETE FROM analysis_data WHERE analysis_id = #id#
    </statement>

    <statement id="delete-analysis"
               parameterClass="java.lang.Long">
        DELETE FROM analysis WHERE id = #id#
    </statement>

    <statement id="delete-analysis-style"
               parameterClass="java.lang.Long">
        <!-- Note! id is style_id from analysis table -->
        DELETE FROM analysis_style WHERE id = #id#
    </statement>
    <statement id=" delete-analysis-style-by-analysis-id"
               parameterClass="java.lang.Long">
        <!-- Note! id is style_id from analysis table -->
        DELETE FROM analysis_style WHERE id = #id#
    </statement>

    <update id="updatePublisherName"
        parameterClass="Map">
        update analysis set
            publisher_name = #publisher_name:VarChar#
        where uuid = #uuid# and id = #id#
    </update>
    
    <select id="findSharedAnalysisIds" 
        resultClass="java.lang.String" parameterClass="java.lang.Long">
        select 
            oskari_user_gis_data.data_id
        from 
            oskari_user_gis_data
        INNER JOIN liiteri_sharing ON liiteri_sharing.resourceid = oskari_user_gis_data.id
        WHERE liiteri_sharing.credentialtype = 'USER' 
        	AND liiteri_sharing.credentialid = #userId#
			AND liiteri_sharing.resourcetype = 'LAYER'
        	AND oskari_user_gis_data.data_type = 'ANALYSIS'
    </select>
    
    <select id="findSharedAnalysis" 
        resultMap="UserGisDataResult" parameterClass="java.lang.Long">
        select 
            oskari_user_gis_data.data_id,
            oskari_user_gis_data.download_service_url,
            oskari_user_gis_data.expirationdate
        from 
            oskari_user_gis_data
        INNER JOIN liiteri_sharing ON liiteri_sharing.resourceid = oskari_user_gis_data.id
        WHERE liiteri_sharing.credentialtype = 'USER' 
        	AND liiteri_sharing.credentialid = #userId#
			AND liiteri_sharing.resourcetype = 'LAYER'
        	AND oskari_user_gis_data.data_type = 'ANALYSIS'
    </select>
    
    <select id="findUnexpiredAnalysis" 
    resultMap="UserGisDataResult" parameterClass="java.lang.Long">
        select 
            oskari_user_gis_data.data_id,
            oskari_user_gis_data.download_service_url,
            oskari_user_gis_data.expirationdate
        from 
            oskari_user_gis_data
        WHERE oskari_user_gis_data.userId = #userId#
        	AND oskari_user_gis_data.data_type = 'ANALYSIS'
    </select>

</sqlMap>